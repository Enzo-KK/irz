<?php/*** Created by PhpStorm.* User: Constantin Krayushkin* Date: 12.02.21* Time: 13:01*/// обработка бд с показаниямиrequire_once 'mySecure.php';require_once 'myClass.php';require 'vendor/autoload.php';use PhpOffice\PhpSpreadsheet\Spreadsheet;use PhpOffice\PhpSpreadsheet\Writer\Xlsx;use PhpOffice\PhpSpreadsheet\Style\{Font, Border, Alignment};// коннектимся к бд$link = connect_to_db ();// 1 это демо вариант, приборы начинаются с 2$uz = isset($_POST['uzel']) ? $_POST['uzel'] : 1;$d_s = isset($_POST['dat_s']) ? $_POST['dat_s'] : '01/01/2021';$d_po = isset($_POST['dat_po']) ? $_POST['dat_po'] : '31/01/2021';/*$uz_str = $uz==1 ? 'Советская 176/195' : $uz;*/// использовал преобразованную дату, но в базе она не понять чему соответствует$ds_s = strtotime($d_s);$ds_po = strtotime($d_po);// месяц показаний. месяц выдается на английском$d_mes = date('F Y', $ds_po);// по другому пробую. отправю дату, а там преобразую$d_mes = $ds_po;//$d_mes = date('d.m.Y', $ds_po);// даты периода просмотра$d_s = date('d.m.Y', $ds_s);$d_po = date('d.m.Y', $ds_po);// лучше по конкретным датам//$ds_s = date('m/d/Y', $ds_s) . '%';//$ds_s = '03/26/2021%';//$ds_po = date('m/d/Y', $ds_po) . '%';$ds_s = date('Y-m-d', $ds_s);$ds_po = date('Y-m-d', $ds_po);// корректировка датастампа. почему то не текущий//$ds_s -= 934559999;///$ds_s -= 426067201;///$ds_po -= 934559999-86400;//$ds_po -= 934300799-86400;// выбираем показания// было по даташтампу//$sql_str = "select * FROM present_day as pd, equip as eq WHERE pd.id=eq.id and pd.id='{$uz}' and pd.timestamp>='{$ds_s}' and pd.timestamp<='{$ds_po}' order by pd.timestamp ";// теперь по дате//$sql_str = "select * FROM present_day as pd, equip as eq WHERE pd.id=eq.id and pd.id='{$uz}' and convert(str_to_date(pd.time,'%m/%d/%Y'), date)>='{$ds_s}' and convert(str_to_date(pd.time,'%m/%d/%Y'), date)<='{$ds_po}' order by pd.timestamp ";// добавил поставщика и потребителя$sql_str = "select * FROM present_day as pd, equip as eq, partic as pa WHERE pd.id=eq.id and pd.id=pa.id and pd.id='{$uz}' and convert(str_to_date(pd.time,'%m/%d/%Y'), date)>='{$ds_s}' and convert(str_to_date(pd.time,'%m/%d/%Y'), date)<='{$ds_po}' order by pd.timestamp ";//$sql_str = 'select * FROM present_day ';$sql = mysqli_query($link,$sql_str);//$row = mysqli_fetch_array($sql);// задекларируем, а то там куча чего копится$pokazania = array();while($row = mysqli_fetch_array($sql))//while($row = mysqli_fetch_row($sql)){    $pokazania[] = $row;}// 1 это демо вариант, приборы начинаются с 2$uz_str = $uz==1 ? 'Советская 176/--' : $pokazania[0]['adress'];// наименование и номер прибора$nm=$pokazania[0]['name'];$sn=$pokazania[0]['snum'];// поставщик и потребитель$prov=$pokazania[0]['prov'];$cons=$pokazania[0]['cons'];$q_all=0;$m_all=0;$t_nar_t=0;$t_nar_n=0;// имя файла для сохранения//$fl_name = 'uzel' . $uz . '_on_date_' . $d_po . '.txt';//$fl_name_sv = 'insite/uzel' . $uz . '_on_date_' . $d_po . '.txt';// лучше так, чтоб файлы на сервере не копились// делаю разные имена по ид прибора//$fl_name = 'uzel_data.txt';//$fl_name_sv = 'insite/uzel_data.txt';$fl_name = 'uzel_data_' . $uz . '.csv';$fl_name_sv = 'insite/' . $fl_name;// справка//$fl_name_sp = 'uzel_data_' . $uz . '_spr.csv';//$fl_name_sp_sv = 'insite/' . $fl_name_sp;$fl_name_sp = 'uzel_data_' . $uz . '_spr.xlsx';$fl_name_sp_sv = 'insite/' . $fl_name_sp;// сразу пишем в файл//file_put_contents($fl_name_sv, $str_print1); // набираем текст для записи в файл-отчет$str_print1 = "ПОСУТОЧНАЯ СТАТИСТИКА\r\n\r\nУзел учета: \t" . $uz_str . "\r\nТип прибора: \t";$str_print2 = "Дата\tQ,ГКал\tM1,т\tM2,т\tMрасх,т\tV1,m3\tV2,m3\tt1,C\tt2,C\tP1,Мпа\tP2,МПа\tТнар,ч\n\r";// калькулируем итоги и заодно готовим дополняем стороку для записи в файлfor ($i = 0; $i < count($pokazania); $i++) {	$q_all+= $pokazania[$i]['wts'];	$m_all+=$pokazania[$i]['mts'] ;	// высчитываем часы от секунд	$t_nar1=$pokazania[$i]['tnar']/3600;	// время простоя	$t_nar_n+=24-$t_nar1;	// часов за период	$t_nar_t+=$t_nar1;		$str_print2 .= $pokazania[$i]['time'] . "\t" . number_format($pokazania[$i]['wts'],2) . "\t" . number_format($pokazania[$i]['m1'],2) . "\t" . number_format($pokazania[$i]['m2'],2)        . "\t" . number_format($pokazania[$i]['mts'],2) . "\t" . number_format($pokazania[$i]['v1'],2) . "\t" . number_format($pokazania[$i]['v2'],2) . "\t"        . number_format($pokazania[$i]['t1'],2) . "\t" . number_format($pokazania[$i]['t2'],2) . "\t" . number_format($pokazania[$i]['p1'],2) . "\t"        . number_format($pokazania[$i]['p2'],2) ."\t" . $t_nar1 . "\r\n";}// форматируем итоги$q_all= number_format($q_all,2,'.',' ');$m_all= number_format($m_all,2,'.',' ');// значения приборов на первую дату периода$w_t1=number_format($pokazania[0]['w_t']-$pokazania[0]['wts'],2,'.',' ');$m_t1=number_format($pokazania[0]['m_t']-$pokazania[0]['mts'],2,'.',' ');// у тэма по другому. и вообще, по тэму надо бы свериться со справкой$m_t1 = $uz==2 ? $m_t1 : number_format($pokazania[0]['m_t']-$pokazania[0]['m1'],2,'.',' ');// значения приборов на последнюю дату периода$w_t=number_format($pokazania[count($pokazania)-1]['w_t'],2,'.',' ');$m_t=number_format($pokazania[count($pokazania)-1]['m_t'],2,'.',' ');// добиваем строку$str_print1 .= $pokazania[0]['name'] . "\tНомер прибора: \t" . $pokazania[0]['snum'] . "\r\n\r\n" . $str_print2 . "\r\n\r\nПоказания интеграторов \tна " . $d_s . "\tна " . $d_po . "\tза период\r\n\r\nКоличество тепла, ГКал: \t" . $w_t1 ."\t" . $w_t ."\t" . $q_all . "\r\nРасход теплоносителя, т: \t" . $m_t1 . "\t" . $m_t . "\t" . $m_all . "\r\nВремя наработки, ч \t \t \t" . $t_nar_t . "\r\nВремя простоя, ч \t \t \t" . $t_nar_n;// теперь набираем текст для записи в файл-справку// корявая получается$str_print_spr = "\t\t\tСПРАВКА\r\n\t\t\t\t\t\t" . date('d.m.Y') . "\r\n\t\tо теплопотреблении за " . $d_mes . "\r\n\r\n\tДоговор №___\tАдрес: " . $uz_str ."\r\n\tТип прибора: "    . $pokazania[0]['name'] ."\t№ прибора: " . $pokazania[0]['snum'] . "\r\n\tСистема ГВС открытая\r\n\tВеличина тепловой\t\tМасса воды\t\tВремя работы\t\r\n\tЭнергии Е, Гкал\t\tМ, т\t\tтеплосчетчика, час\t\r\nДата\tПо\tПо\tПо\tПо\tПо\tПо\r\n\tподающему\tобратному\tподающему\tобратному\tподающему\tобратному\r\n\tтрубопроводу\tтрубопроводу\tтрубопроводу\tтрубопроводу\tтрубопроводу\tтрубопроводу\r\n"    . $d_s . "\t" . $w_t1 . "\t0,0\t" . $m_t1 . "\t--\t--\t\r\n" . $d_po ."\t" . $w_t . "\t0,0\t" . $m_t . "\t--\t--\t\r\nПрибор не работал\t"    . $t_nar_n . "\tчасов\tподача теплоносителя в это время осуществлялась\r\n\t\t\tрасход по трубопроводам\tне фиксировался\t\r\n\t\tПо счетчику\tДосчет\tДовыставлено\tДосчет до конца\tИтого\r\n\t\t\tнедоработки\t\tмесяца\t\r\nРасход тепловой энергии\t\t"    . $q_all ."\t0,0\t-\t0,0\t" . $q_all . "\r\nРасход горячей воды, т\t\t" . $m_all . "\t-\t-\t0,0"    . $m_all . "\r\nРасход горячей воды, м3\t\t\t\t" . $m_all . "т/0,98 т/м3\t\t"    . $m_all ."\r\n\r\nПредставитель ООО ИЭСБК\t\t\t___________________\r\n\r\nПредставитель абонента\t\t\t____________________" ;?><!doctype html><html lang="ru"><head>	<meta charset="utf-8">	<title>УК Правобережье. Показания ПУ</title>	<meta name="viewport" content="width=device-width, initial-scale=1">	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css">	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"> </script>	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"> </script>	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"> </script>	<link rel="icon" href="my-ico.jpg">	<!--    <script src="js/jquery-3.5.1.min.js"></script>-->	<!--    <script src="js/jquery.js"></script>--></head><body><nav class="navbar navbar-expand-md bg-dark navbar-dark fixed-top">	<!--<nav class="navbar navbar-expand-md bg-dark navbar-dark ">-->	<a class="navbar-brand" href="http://khozyain-doma.ru">ООО "УК Правобережье"</a>	<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#collapsibleNavbar">		<span class="navbar-toggler-icon"></span>	</button>	<div class="collapse navbar-collapse" id="collapsibleNavbar">		<ul class="navbar-nav">			<li class="nav-item">				<a class="nav-link active" href="#">Показания</a>			</li>			<li class="nav-item">				<a class="nav-link" href="#">Сервис</a>			</li>			<li class="nav-item">				<a class="nav-link" href="#">Обработка заявок</a>			</li>			<!--            если есть активный опрос добавляем пункт -->			<?php			if (isset($_SESSION['isactopr'])  && $_SESSION['isactopr'] == 1)				: ?>			<li class="nav-item">				<a class="nav-link" href="#">Опрос</a>			</li>			<?php endif; ?>		</ul>	</div></nav><br><br><br><div class="container-fluid"><h3>Показания приборов учета тепла</h3><p>Для выбранного узла учета на диапазон дат</p><form id="choi_period_id" method="POST" action="choi_period.php" name="choi_period"><table id="table" class="table table-striped">	<thead class="thead-dark">		<tr>			<th scope="col" >Узел учета</th>			<th scope="col" >Прибор</th>			<th scope="col" >Сер. №</th>			<th scope="col" colspan="2">Период</th>						</tr>		<tr>		<th scope="col" colspan="3"></th>		<th scope="col" >С даты</th>		<th scope="col" >По дату</th>		</tr>	</thead>	<tbody>		<tr>		<td><?php echo($uz_str) ?></td>							<th scope="col" ><?php echo $nm ?></th>							<th scope="col" ><?php echo $sn ?></th>									<td><?php echo  $d_s; ?></td>		<td><?php echo  $d_po; ?></td>				</tr>	</tbody></table>		<table id="table" class="table table-striped">		<thead >			<tr>			<th scope="col" >Дата</th>			<th scope="col" >Q, Гкал</th>			<th scope="col" >М1, т</th>			<th scope="col" >М2, т</th>			<th scope="col" >Мрасх, т</th>			<th scope="col" >V1, m3</th>			<th scope="col" >V2, m3</th>			<th scope="col" >t1, C</th>			<th scope="col" >t2, C</th>			<th scope="col" >p1, МПа</th>						<th scope="col" >p2, Мпа</th>			<th scope="col" >Тнар, ч</th>						</tr>		</thead>		<tbody><?php // вывод показаний	for ($i = 0; $i < count($pokazania); $i++) {		// высчитываем часы от секунд		$t_nar=$pokazania[$i]['tnar']/3600;	 	print "<tr>		<td>".$pokazania[$i]['time']."</td>        <td>".$pokazania[$i]['wts']."</td>		<td>".$pokazania[$i]['m1']."</td>		<td>".$pokazania[$i]['m2']."</td>		        <td>".$pokazania[$i]['mts']."</td>		<td>".$pokazania[$i]['v1']."</td>		<td>".$pokazania[$i]['v2']."</td>        <td>".$pokazania[$i]['t1']."</td>		<td>".$pokazania[$i]['t2']."</td>		<td>".$pokazania[$i]['p1']."</td>		<td>".$pokazania[$i]['p2']."</td>		<td>".$t_nar."</td>        </tr>"; } ?>	</tbody></table>	<table id="table3" class="table table-striped">		<thead >		<tr>			<th scope="col" colspan="3">Итого за период</th>		</tr>		<tr>			<th scope="col" >Q, ГКал</th>			<th scope="col" >Мрасх, т</th>			<th scope="col" >Тнар, ч</th>		</tr>		</thead>		<tbody>		<tr>			<td><?php echo $q_all ?></td>			<td><?php echo $m_all ?></td>			<td><?php echo $t_nar_t ?></td>       	</tr>		</tbody>		</table>			<hr />	<a class="btn btn-secondary"  href="user_lc.php" role="button" title="Вернуться к выбору периода">Вернуться</a>		<a class="btn btn-success"  role="button" onclick="setNewData('<?php echo $fl_name ; ?>');return false;" title="Сохранить таблицу в файл">Сохранить</a>		<div class="float-right" id="my_file"></div>	<hr />		<script>		// нажатие кнопки формирует файл		function setNewData(dt)			{			<?php                // пишем в файл таблицу                file_put_contents($fl_name_sv, $str_print1);                // формируем и пишем в файл справку                WrtXls($fl_name_sp_sv, $prov, $cons, $d_mes, $uz_str, $nm, $sn, $d_s, $d_po, $w_t1, $m_t1, $w_t, $m_t, $q_all, $m_all, $t_nar_t, $t_nar_n);			?>                // вывод линка только таблицы             //htmlstr = '<a target="_blank" href="<?php //echo $fl_name_sv ; ?>//" >Таблица сохранена в файл: <?php //echo $fl_name ; ?>//</a>';			// вывод линков таблицы и справки			htmlstr = '<a target="_blank" href="<?php echo $fl_name_sv ; ?>" >Таблица сохранена в файл: <?php echo $fl_name ; ?></a><br><a target="_blank" href="<?php echo $fl_name_sp_sv ; ?>" >Справка сохранена в файл: <?php echo $fl_name_sp ; ?></a>';			$('#my_file').html(htmlstr);		}</script></body></html>